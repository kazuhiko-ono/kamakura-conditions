<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>鎌倉コンディション</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 16px;
      max-width: 600px;
    }
    pre {
      background: #f0f0f0;
      padding: 8px;
      overflow-x: auto;
      font-size: 12px;
    }
    button {
      margin-top: 12px;
      padding: 8px 16px;
      font-size: 14px;
    }
    .wind-section {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 8px;
    }
    .compass {
      position: relative;
      width: 100px;
      height: 100px;
      border: 2px solid #666;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .compass-labels {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    .compass-labels span {
      position: absolute;
      font-size: 12px;
      font-weight: bold;
      color: #333;
    }
    .compass-labels .dir-n { top: 2px; left: 50%; transform: translateX(-50%); }
    .compass-labels .dir-s { bottom: 2px; left: 50%; transform: translateX(-50%); }
    .compass-labels .dir-e { right: 4px; top: 50%; transform: translateY(-50%); }
    .compass-labels .dir-w { left: 4px; top: 50%; transform: translateY(-50%); }
    .wind-arrow {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 4px;
      height: 40px;
      margin-left: -2px;
      margin-top: -40px;
      background: #e74c3c;
      transform-origin: bottom center;
    }
    .wind-arrow::after {
      content: '';
      position: absolute;
      top: -6px;
      left: -5px;
      width: 0;
      height: 0;
      border-left: 7px solid transparent;
      border-right: 7px solid transparent;
      border-bottom: 10px solid #e74c3c;
    }
    .wind-info {
      font-size: 14px;
      line-height: 1.6;
    }
    .wave-section {
      display: flex;
      align-items: flex-end;
      gap: 16px;
      margin-top: 8px;
    }
    .wave-bar-container {
      width: 40px;
      height: 100px;
      background: #eee;
      border: 1px solid #ccc;
      display: flex;
      align-items: flex-end;
      flex-shrink: 0;
    }
    .wave-bar {
      width: 100%;
      background: #3498db;
    }
    .wave-info {
      font-size: 14px;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <h1>鎌倉コンディション</h1>
  <p>七里ヶ浜〜坂ノ下エリア</p>

  <p id="status">読み込み中...</p>

  <div id="result"></div>

  <button id="refresh" onclick="fetchAll()">再取得</button>

  <h2>デバッグ: 生JSON</h2>
  <h3>Weather API</h3>
  <pre id="debug-weather"></pre>
  <h3>Marine API</h3>
  <pre id="debug-marine"></pre>

  <script>
    const LAT = 35.3025;
    const LON = 139.5232;
    const WEATHER_URL = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&current=temperature_2m,apparent_temperature,wind_speed_10m,wind_direction_10m,wind_gusts_10m,weather_code&timezone=Asia%2FTokyo`;
    const MARINE_URL = `https://marine-api.open-meteo.com/v1/marine?latitude=${LAT}&longitude=${LON}&current=wave_height,wave_direction,wave_period,swell_wave_height,swell_wave_direction,swell_wave_period&timezone=Asia%2FTokyo`;

    const WEATHER_CODES = {
      0: '快晴',
      1: '晴れ',
      2: '一部曇り',
      3: '曇り',
      45: '霧',
      48: '着氷性の霧',
      51: '弱い霧雨',
      53: '霧雨',
      55: '強い霧雨',
      61: '弱い雨',
      63: '雨',
      65: '強い雨',
      71: '弱い雪',
      73: '雪',
      75: '強い雪',
      80: '弱いにわか雨',
      81: 'にわか雨',
      82: '強いにわか雨',
      95: '雷雨',
      96: '雹を伴う雷雨',
      99: '強い雹を伴う雷雨'
    };

    function windDirectionToText(deg) {
      const dirs = ['北', '北北東', '北東', '東北東', '東', '東南東', '南東', '南南東',
                     '南', '南南西', '南西', '西南西', '西', '西北西', '北西', '北北西'];
      const index = Math.round(deg / 22.5) % 16;
      return dirs[index];
    }

    async function fetchWeatherData() {
      const res = await fetch(WEATHER_URL);
      if (!res.ok) throw new Error(`Weather API HTTP ${res.status}`);
      return await res.json();
    }

    async function fetchMarineData() {
      const res = await fetch(MARINE_URL);
      if (!res.ok) throw new Error(`Marine API HTTP ${res.status}`);
      return await res.json();
    }

    function renderWeather(data) {
      const c = data.current;
      const units = data.current_units;
      const weatherText = WEATHER_CODES[c.weather_code] || `コード: ${c.weather_code}`;
      const windDirText = windDirectionToText(c.wind_direction_10m);
      const arrowDeg = c.wind_direction_10m;

      return `
        <h2>風・気象</h2>
        <div id="weather-table">
          <div class="wind-section">
            <div class="compass">
              <div class="compass-labels">
                <span class="dir-n">N</span>
                <span class="dir-s">S</span>
                <span class="dir-e">E</span>
                <span class="dir-w">W</span>
              </div>
              <div class="wind-arrow" style="transform: rotate(${arrowDeg}deg)"></div>
            </div>
            <div class="wind-info">
              <div>${weatherText}</div>
              <div>気温 ${c.temperature_2m}${units.temperature_2m} / 体感 ${c.apparent_temperature}${units.apparent_temperature}</div>
              <div>風速 ${c.wind_speed_10m}${units.wind_speed_10m}</div>
              <div>風向 ${windDirText}（${c.wind_direction_10m}${units.wind_direction_10m}）</div>
              <div>突風 ${c.wind_gusts_10m}${units.wind_gusts_10m}</div>
            </div>
          </div>
          <p>取得時刻: ${c.time}</p>
        </div>
      `;
    }

    function renderMarine(data) {
      const c = data.current;
      const units = data.current_units;
      const waveDirText = windDirectionToText(c.wave_direction);
      const swellDirText = windDirectionToText(c.swell_wave_direction);
      const barHeight = Math.max(10, Math.min(85, c.wave_height * 40));

      return `
        <h2>波</h2>
        <div id="marine-table">
          <div class="wave-section">
            <div class="wave-bar-container">
              <div class="wave-bar" style="height: ${barHeight}px"></div>
            </div>
            <div class="wave-info">
              <div>波高 ${c.wave_height}${units.wave_height}</div>
              <div>波周期 ${c.wave_period}${units.wave_period}</div>
              <div>波向 ${waveDirText}（${c.wave_direction}${units.wave_direction}）</div>
              <div>うねり高 ${c.swell_wave_height}${units.swell_wave_height}</div>
              <div>うねり周期 ${c.swell_wave_period}${units.swell_wave_period}</div>
              <div>うねり向 ${swellDirText}（${c.swell_wave_direction}${units.swell_wave_direction}）</div>
            </div>
          </div>
          <p>取得時刻: ${c.time}</p>
        </div>
      `;
    }

    async function fetchAll() {
      const statusEl = document.getElementById('status');
      const resultEl = document.getElementById('result');
      const debugWeatherEl = document.getElementById('debug-weather');
      const debugMarineEl = document.getElementById('debug-marine');

      statusEl.textContent = '読み込み中...';
      resultEl.innerHTML = '';
      debugWeatherEl.textContent = '';
      debugMarineEl.textContent = '';

      const [weatherResult, marineResult] = await Promise.allSettled([
        fetchWeatherData(),
        fetchMarineData()
      ]);

      let html = '';
      const errors = [];

      if (weatherResult.status === 'fulfilled') {
        html += renderWeather(weatherResult.value);
        debugWeatherEl.textContent = JSON.stringify(weatherResult.value, null, 2);
      } else {
        html += '<h2>風・気象</h2><p>風データを取得できませんでした。</p>';
        debugWeatherEl.textContent = String(weatherResult.reason);
        errors.push('風データ');
      }

      if (marineResult.status === 'fulfilled') {
        html += renderMarine(marineResult.value);
        debugMarineEl.textContent = JSON.stringify(marineResult.value, null, 2);
      } else {
        html += '<h2>波</h2><p>波データを取得できませんでした。</p>';
        debugMarineEl.textContent = String(marineResult.reason);
        errors.push('波データ');
      }

      resultEl.innerHTML = html;

      if (errors.length === 0) {
        statusEl.textContent = '取得成功';
      } else if (errors.length === 2) {
        statusEl.textContent = 'エラー: すべてのデータ取得に失敗しました';
      } else {
        statusEl.textContent = `一部エラー: ${errors.join('、')}の取得に失敗`;
      }
    }

    fetchAll();
  </script>
</body>
</html>
