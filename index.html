<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>鎌倉コンディション</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 16px;
      max-width: 600px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 8px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 10px;
      text-align: left;
    }
    th {
      background: #f5f5f5;
      width: 40%;
    }
    pre {
      background: #f0f0f0;
      padding: 8px;
      overflow-x: auto;
      font-size: 12px;
    }
    button {
      margin-top: 12px;
      padding: 8px 16px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>鎌倉コンディション</h1>
  <p>七里ヶ浜〜坂ノ下エリア</p>

  <p id="status">読み込み中...</p>

  <div id="result"></div>

  <button id="refresh" onclick="fetchWeather()">再取得</button>

  <h2>デバッグ: 生JSON</h2>
  <pre id="debug"></pre>

  <script>
    const LAT = 35.3025;
    const LON = 139.5232;
    const API_URL = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&current=temperature_2m,apparent_temperature,wind_speed_10m,wind_direction_10m,wind_gusts_10m,weather_code&timezone=Asia%2FTokyo`;

    const WEATHER_CODES = {
      0: '快晴',
      1: '晴れ',
      2: '一部曇り',
      3: '曇り',
      45: '霧',
      48: '着氷性の霧',
      51: '弱い霧雨',
      53: '霧雨',
      55: '強い霧雨',
      61: '弱い雨',
      63: '雨',
      65: '強い雨',
      71: '弱い雪',
      73: '雪',
      75: '強い雪',
      80: '弱いにわか雨',
      81: 'にわか雨',
      82: '強いにわか雨',
      95: '雷雨',
      96: '雹を伴う雷雨',
      99: '強い雹を伴う雷雨'
    };

    function windDirectionToText(deg) {
      const dirs = ['北', '北北東', '北東', '東北東', '東', '東南東', '南東', '南南東',
                     '南', '南南西', '南西', '西南西', '西', '西北西', '北西', '北北西'];
      const index = Math.round(deg / 22.5) % 16;
      return dirs[index];
    }

    async function fetchWeather() {
      const statusEl = document.getElementById('status');
      const resultEl = document.getElementById('result');
      const debugEl = document.getElementById('debug');

      statusEl.textContent = '読み込み中...';
      resultEl.innerHTML = '';
      debugEl.textContent = '';

      try {
        const res = await fetch(API_URL);
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const data = await res.json();
        const c = data.current;
        const units = data.current_units;

        const weatherText = WEATHER_CODES[c.weather_code] || `コード: ${c.weather_code}`;
        const windDirText = windDirectionToText(c.wind_direction_10m);

        resultEl.innerHTML = `
          <table>
            <tr><th>天気</th><td>${weatherText}</td></tr>
            <tr><th>気温</th><td>${c.temperature_2m}${units.temperature_2m}</td></tr>
            <tr><th>体感温度</th><td>${c.apparent_temperature}${units.apparent_temperature}</td></tr>
            <tr><th>風速</th><td>${c.wind_speed_10m}${units.wind_speed_10m}</td></tr>
            <tr><th>風向</th><td>${windDirText}（${c.wind_direction_10m}${units.wind_direction_10m}）</td></tr>
            <tr><th>突風</th><td>${c.wind_gusts_10m}${units.wind_gusts_10m}</td></tr>
          </table>
          <p>取得時刻: ${c.time}</p>
        `;

        statusEl.textContent = '取得成功';
        debugEl.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        statusEl.textContent = 'エラー: ' + err.message;
        resultEl.innerHTML = '<p>データを取得できませんでした。再取得ボタンを押してください。</p>';
        debugEl.textContent = String(err);
      }
    }

    fetchWeather();
  </script>
</body>
</html>
